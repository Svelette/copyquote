<!doctype html>
<html lang="zh-CN" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-Brand Menu System</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Belleza&family=Noto+Serif+SC:wght@300;400;500;600&family=Allison&display=swap');

    /* Ëã±ÊñáÔºöBelleza ÔΩú ‰∏≠ÊñáÔºöNoto Serif SC ÔΩú ÂêçÂ≠óÔºöAllison */
    .sans-font { font-family: 'Belleza', 'Noto Serif SC', serif; }
    .serif-font { font-family: 'Belleza', 'Noto Serif SC', serif; }
    .allison { font-family: 'Allison', cursive; }

    .menu-item { transition: all 0.3s ease; cursor: pointer; }
    .menu-item:hover { transform: translateX(8px); }
    .selected-item { background: rgba(255, 255, 255, 0.05); border-left: 3px solid; }

    .cart-item { animation: slideIn 0.3s ease; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* Glass / gradient button system */
    .glass-btn {
      border: 1px solid rgba(160, 97, 106, 0.28);
      background: rgba(255, 255, 255, 0.62);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      transition: transform .16s ease, box-shadow .16s ease, background .16s ease, border-color .16s ease;
    }
    .glass-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 34px rgba(0,0,0,0.10);
      background: rgba(255, 255, 255, 0.78);
      border-color: rgba(160, 97, 106, 0.40);
    }
    .glass-btn:active { transform: translateY(0px) scale(0.99); }

    .gradient-btn {
      border: 1px solid rgba(160, 97, 106, 0.28);
      background: linear-gradient(135deg, rgba(255,255,255,0.76), rgba(139,0,0,0.18));
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
    }
    .gradient-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 34px rgba(0,0,0,0.10);
      filter: saturate(1.05);
    }
    .gradient-btn:active { transform: translateY(0px) scale(0.99); }

    /* ===== New: segmented controls (region + nav) ===== */
    .seg-wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .seg-group{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:0;
      border-radius: 999px;
      padding: 6px;
      background: rgba(255,255,255,0.62);
      border: 1px solid rgba(160,97,106,0.22);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.08);
    }
    .seg-btn{
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 10px 16px;
      min-height: 42px;
      transition: transform .16s ease, background .16s ease, box-shadow .16s ease, color .16s ease;
      letter-spacing: 1.2px;
      font-weight: 600;
      cursor: pointer;
      user-select:none;
    }
    .seg-btn:hover{ transform: translateY(-1px); }
    .seg-btn.active{
      background: rgba(139,0,0,0.96);
      box-shadow: 0 16px 34px rgba(0,0,0,0.12);
      color: #ffffff !important;
    }
    .seg-btn:not(.active){
      color: rgba(119,0,8,0.86);
    }
    .seg-sep{
      width: 1px;
      height: 18px;
      background: rgba(160,97,106,0.28);
      margin: 0 6px;
    }
    @media (max-width: 640px){
      .seg-group{ padding: 5px; }
      .seg-btn{ padding: 9px 12px; min-height: 38px; font-size: 12px !important; letter-spacing: 1px !important; }
    }

    /* Floating brand switcher + dropdown (keep) */
    .floating-switcher {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }

    .floating-panel {
      margin-top: 8px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(160, 97, 106, 0.25);
      box-shadow: 0 14px 30px rgba(0,0,0,0.08);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(255,255,255,0.76);
      transform-origin: top right;
      animation: popIn .16s ease;
      min-width: 240px;
    }
    @keyframes popIn {
      from { opacity: 0; transform: translateY(-6px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .floating-item {
      width: 100%;
      text-align: left;
      padding: 12px 14px;
      cursor: pointer;
      transition: background .15s ease, transform .15s ease;
      background: transparent;
      border: none;
    }
    .floating-item:hover { background: rgba(139,0,0,0.08); transform: translateX(2px); }
    .floating-subtitle {
      opacity: 0.75;
      font-size: 12px;
      letter-spacing: 1px;
    }
    .divider { height: 1px; background: rgba(160, 97, 106, 0.25); }

    /* Operator name (below year) */
    .operator-top {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 2px;
      margin-bottom: 14px;
    }
    .operator-name {
      font-family: 'Allison', cursive;
      font-size: 30px;
      line-height: 1;
      color: #770008;
      letter-spacing: 1px;
    }

    /* Hamburger icon button */
    .icon-btn {
      width: 62px;
      height: 44px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 0;
    }
    .hamburger {
      width: 18px;
      height: 12px;
      display: inline-flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .hamburger span {
      display: block;
      height: 2px;
      width: 100%;
      background: rgba(119,0,8,0.78);
      border-radius: 999px;
    }
    .icon-btn.is-open .hamburger span:nth-child(2) { opacity: 0.55; width: 70%; }
    .icon-btn.is-open .hamburger span:nth-child(3) { width: 85%; }

    /* History modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      padding: 18px;
    }
    .modal-card {
      width: min(860px, 96vw);
      max-height: min(78vh, 720px);
      overflow: auto;
      border-radius: 18px;
      border: 1px solid rgba(160, 97, 106, 0.25);
      background: rgba(255,255,255,0.84);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 22px 60px rgba(0,0,0,0.18);
    }
    .modal-top {
      position: sticky;
      top: 0;
      background: rgba(255,255,255,0.88);
      border-bottom: 1px solid rgba(160, 97, 106, 0.20);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-row {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(160, 97, 106, 0.14);
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      opacity: .85;
    }
  </style>
</head>

<body class="h-full sans-font">
  <div id="app" class="h-full w-full overflow-auto"></div>

  <!-- History Modal -->
  <div id="history-modal" class="modal-backdrop">
    <div class="modal-card">
      <div class="modal-top">
        <div>
          <div class="serif-font" style="font-size:18px; letter-spacing:1px; font-weight:400; color:#770008;">History</div>
          <div class="sans-font" style="font-size:12px; opacity:.7; letter-spacing:1px;">ÊúÄËøëÂ§çÂà∂ËÆ∞ÂΩïÔºàÊúÄÂ§ö30Êù°Ôºâ</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="history-clear" class="glass-btn sans-font px-4 py-2 rounded-full" style="font-size:12px; letter-spacing:1px; color:#770008;">CLEAR</button>
          <button id="history-close" class="gradient-btn sans-font px-4 py-2 rounded-full" style="font-size:12px; letter-spacing:1px; color:#3b1b1f;">CLOSE</button>
        </div>
      </div>
      <div id="history-list"></div>
    </div>
  </div>

  <script>
    /**********************
     * 0) ‰Ω†ÁöÑ‚Äú‰∫ëÁ´ØËÆæÁΩÆ‚Äù
     **********************/
    const SUPABASE_URL = "";
    const SUPABASE_ANON_KEY = "";

    /**********************
     * 1) ‰Ω†ÁöÑÊìç‰ΩúËÄÖÂêçÂ≠óÂàóË°®
     **********************/
    const OPERATOR_OPTIONS = [
      "Charlotte","Aaron","Celeste","Jayden","Jovie","Fiona","Yuki","Maria"
    ];

    /**********************
     * 2) team keyÔºàÈìæÊé• hash Â∏¶ teamÔºâ
     *    Áî®Ê≥ïÔºö https://xxx.com/#team=CHYU-TEAM-2026
     **********************/
    function getTeamKey() {
      const hash = (location.hash || "").replace(/^#/, "");
      const params = new URLSearchParams(hash);
      const t = params.get("team");
      return (t && t.trim()) ? t.trim() : "DEFAULT_TEAM";
    }
    const TEAM_KEY = getTeamKey();

    /**********************
     * 3) Êú¨Êú∫Â≠òÂÇ® keysÔºàÊåâ team ÈöîÁ¶ªÔºâ
     **********************/
    const LS_PREFIX = `MBMS_${TEAM_KEY}_`;
    const LS_KEYS = {
      OPERATOR: LS_PREFIX + "operator",
      APP_STATE: LS_PREFIX + "app_state",
      LOGGED_IN: LS_PREFIX + "logged_in",
      HISTORY:  LS_PREFIX + "history"
    };

    /**********************
     * 4) ÈªòËÆ§‰∏ªÈ¢ò
     **********************/
    const defaultConfig = {
      restaurant_name: 'Svelette Birdnest',
      tagline: 'Happy New Year',
      background_color: '#faf8f5',
      surface_color: '#ffffff',
      text_color: '#7d1f3c',
      primary_action_color: '#8b0000',
      secondary_action_color: '#a0616a',
      font_family: 'Belleza',
      font_size: 16
    };

    /**********************
     * 5) ÂìÅÁâåÊï∞ÊçÆ
     **********************/
    const brandData = {
      svelette: {
        name: 'Svelette Birdnest',
        tagline: 'Happy New Year',
        menu: [
          { id: 'item1', name: 'Ë¥¢Ê∫êÊªöÊªö', price: 68 },
          { id: 'item2', name: 'ÂñúÁãÆËøûËøû', price: 98 },
          { id: 'item3', name: 'ÂñúËøéÂπ¥Âπ¥', price: 108 },
          { id: 'item4', name: 'Âñú‰∫ãÂ§öÂ§ö', price: 128 },
          { id: 'item5', name: 'ÁîúËúúÂºÄËøê', price: 138 },
          { id: 'item6', name: 'ÂñúÂ∫ÜÊ¥ãÊ¥ã', price: 188 },
          { id: 'item7', name: 'ÁπÅËä±‰ººÈî¶', price: 198 },
          { id: 'item8', name: 'ÂñúÂ∫ÜËøéÈó®', price: 228 },
          { id: 'item9', name: 'Â≤ÅÂ≤ÅËøõË¥¢', price: 258 },
          { id: 'item10', name: 'ÊóãËΩ¨Êú®È©¨', price: 328 },
          { id: 'item11', name: 'ÊóãËΩ¨Êú®È©¨', price: 398 },
          { id: 'item12', name: 'ÊóãËΩ¨Êú®È©¨', price: 688 }
        ]
      },
      chyu: {
        name: 'CHYU CONCEPT',
        tagline: 'Premium Gifts',
        menu: [
          { id: 'chyu1', name: 'Á¶èÊª°Á§ºÁõí', price: 88 },
          { id: 'chyu2', name: 'Â¶ÇÊÑèÁ§ºÁõí', price: 128 },
          { id: 'chyu3', name: 'Á••ÁëûÁ§ºÁõí', price: 168 },
          { id: 'chyu4', name: 'ÂêâÁ••Â¶ÇÊÑè', price: 198 },
          { id: 'chyu5', name: 'Á¶èÁ¶ÑÂèåÂÖ®', price: 238 },
          { id: 'chyu6', name: 'ÂØåË¥µÊª°Â†Ç', price: 288 }
        ]
      }
    };

    /**********************
     * 6) ÈªòËÆ§ state
     *    ‚úÖ Êñ∞Â¢ûÔºöÊØè‰∏™Ê®°ÊùøÊãÜÊàê zh/en
     **********************/
    const defaultState = () => ({
      version: 2,
      currentBrand: 'svelette',
      selectedItems: [],
      currentPage: 'new',
      currentRegion: 'west',

      // ÂèØÈÄâÔºöÊú™Êù•‰Ω†Ë¶ÅÂÅöËØ≠Ë®ÄÂàáÊç¢Áî®ÔºàÁé∞Âú® copy ÊåâÈíÆÂ∑≤ÂàÜÂºÄÔºåËøô‰∏™ÂÖà‰øùÁïôÔºâ
      currentLang: 'zh',

      menuItemsStateByBrand: {
        svelette: brandData.svelette.menu.map(item => ({
          ...item, visible: true, customName: item.name, customPrice: item.price
        })),
        chyu: brandData.chyu.menu.map(item => ({
          ...item, visible: true, customName: item.name, customPrice: item.price
        }))
      },

      // ‚úÖ Ê®°ÊùøÁé∞Âú®ÂèòÊàê { zh: "...", en: "..." }
      savedTemplatesByBrand: {
        svelette: {
          west: {
            delivery: {
              zh: `Ë•øÈ©¨ÂåÖÈÇÆ
„ÄêTOTAL: RM„Äë

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÂë®Ôºö

ÂèØ‰ªé‰ª•‰∏ãÊó•ÊúüÈÄâÊã©ÂèëË¥ßÂë®
Êàë‰ª¨‰ºöÂú®ÈÇ£Âë®ÁöÑÊòüÊúü‰∏ÄËá≥ÊòüÊúü‰∫î‰ªª‰Ωï‰∏ÄÂ§©ÂèëË¥ß
ÂØÑÂá∫Âêé‰ºöÂú®1-3Â§©ÂÜÖÊî∂Âà∞üòâ

ùüè. ùüêùüéùüêùüî/ùüè/ùüì ‚Äì ùüè/ùüó
ùüê. ùüêùüéùüêùüî/ùüè/ùüèùüê ‚Äì ùüè/ùüèùüî
ùüë. ùüêùüéùüêùüî/ùüè/ùüèùüó ‚Äì ùüè/ùüêùüë
ùüí. ùüêùüéùüêùüî/ùüè/ùüêùüî ‚Äì ùüè/ùüëùüé
ùüì. ùüêùüéùüêùüî/ùüê/ùüê ‚Äì ùüê/ùüî
ùüî. ùüêùüéùüêùüî/ùüê/ùüó ‚Äì ùüê/ùüèùüë`,
              en: `Free delivery (West Malaysia)
[TOTAL: RM]

üìÆ Shipping Details

Name:
Phone:
Address:
Delivery week:

Please choose one delivery week below.
We will ship on any weekday (Mon‚ÄìFri) during that week.
Delivery takes 1‚Äì3 days after shipping üòâ

1) 2026/1/5 ‚Äì 1/9
2) 2026/1/12 ‚Äì 1/16
3) 2026/1/19 ‚Äì 1/23
4) 2026/1/26 ‚Äì 1/30
5) 2026/2/2 ‚Äì 2/6
6) 2026/2/9 ‚Äì 2/13`
            },
            lalamove: {
              zh: `„ÄêËøêË¥πÔºöRM„Äë
„ÄêTOTAL: RM„Äë

Êèê‰æõÂú∞ÂùÄÂêéÂ∏Æ‰Ω†Êü•ÁúãËøêË¥πüòâ

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÊó•Ôºö`,
              en: `[Delivery fee: RM]
[TOTAL: RM]

Share your address and we‚Äôll check the delivery fee for you üòâ

üìÆ Delivery Details

Name:
Phone:
Address:
Delivery date:`
            },
            pickup: {
              zh: `„ÄêTOTAL: RM„Äë

üì¶Ëá™ÂèñËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Ëá™ÂèñÂú∞ÁÇπÔºö
Ëá™ÂèñÊó•ÊúüÔºö
Ëá™ÂèñÊó∂Èó¥Ôºö`,
              en: `[TOTAL: RM]

üì¶ Self Pickup Details

Name:
Phone:
Pickup location:
Pickup date:
Pickup time:`
            }
          },
          east: {
            delivery: {
              zh: `„ÄêËøêË¥πÔºöRM„Äë
„ÄêTOTAL: RM„Äë

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÂë®Ôºö

ÂèØ‰ªé‰ª•‰∏ãÊó•ÊúüÈÄâÊã©ÂèëË¥ßÂë®
Êàë‰ª¨‰ºöÂú®ÈÇ£Âë®ÁöÑÊòüÊúü‰∏ÄËá≥ÊòüÊúü‰∫î‰ªª‰Ωï‰∏ÄÂ§©ÂèëË¥ß
ÂØÑÂá∫Âêé‰ºöÂú®1-3Â§©ÂÜÖÊî∂Âà∞üòâ

ùüè. ùüêùüéùüêùüî/ùüè/ùüì ‚Äì ùüè/ùüó
ùüê. ùüêùüéùüêùüî/ùüè/ùüèùüê ‚Äì ùüè/ùüèùüî
ùüë. ùüêùüéùüêùüî/ùüè/ùüèùüó ‚Äì ùüè/ùüêùüë
ùüí. ùüêùüéùüêùüî/ùüè/ùüêùüî ‚Äì ùüè/ùüèùüëùüé
ùüì. ùüêùüéùüêùüî/ùüê/ùüê ‚Äì ùüê/ùüî
ùüî. ùüêùüéùüêùüî/ùüê/ùüó ‚Äì ùüê/ùüèùüë`,
              en: `[Delivery fee: RM]
[TOTAL: RM]

üìÆ Shipping Details

Name:
Phone:
Address:
Delivery week:

Please choose one delivery week below.
We will ship on any weekday (Mon‚ÄìFri) during that week.
Delivery takes 1‚Äì3 days after shipping üòâ`
            }
          },
          singapore: {
            delivery: {
              zh: `ËøêË¥πÔºö$12
„ÄêTOTAL: $„Äë

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÊó•Ôºö`,
              en: `Delivery fee: $12
[TOTAL: $]

üìÆ Delivery Details

Name:
Phone:
Address:
Delivery date:`
            },
            lalamove: {
              zh: `„ÄêËøêË¥πÔºö$„Äë
„ÄêTOTAL: $„Äë

Êèê‰æõÂú∞ÂùÄÂêéÂ∏Æ‰Ω†Êü•ÁúãËøêË¥πüòâ

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÊó•Ôºö`,
              en: `[Delivery fee: $]
[TOTAL: $]

Share your address and we‚Äôll check the delivery fee for you üòâ

üìÆ Delivery Details

Name:
Phone:
Address:
Delivery date:`
            },
            pickup: {
              zh: `„ÄêTOTAL: $„Äë

üì¶Ëá™ÂèñËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Ëá™ÂèñÂú∞ÁÇπÔºö
Ëá™ÂèñÊó•ÊúüÔºö
Ëá™ÂèñÊó∂Èó¥Ôºö`,
              en: `[TOTAL: $]

üì¶ Self Pickup Details

Name:
Phone:
Pickup location:
Pickup date:
Pickup time:`
            }
          }
        },

        chyu: {
          west: {
            delivery: {
              zh: `Ë•øÈ©¨ÂåÖÈÇÆ
„ÄêTOTAL: RM„Äë

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÂë®Ôºö

ÂèØ‰ªé‰ª•‰∏ãÊó•ÊúüÈÄâÊã©ÂèëË¥ßÂë®
Êàë‰ª¨‰ºöÂú®ÈÇ£Âë®ÁöÑÊòüÊúü‰∏ÄËá≥ÊòüÊúü‰∫î‰ªª‰Ωï‰∏ÄÂ§©ÂèëË¥ß
ÂØÑÂá∫Âêé‰ºöÂú®1-3Â§©ÂÜÖÊî∂Âà∞üòâ

ùüè. ùüêùüéùüêùüî/ùüè/ùüì ‚Äì ùüè/ùüó
ùüê. ùüêùüéùüêùüî/ùüè/ùüèùüê ‚Äì ùüè/ùüèùüî
ùüë. ùüêùüéùüêùüî/ùüè/ùüèùüó ‚Äì ùüè/ùüêùüë
ùüí. ùüêùüéùüêùüî/ùüè/ùüêùüî ‚Äì ùüè/ùüèùüëùüé
ùüì. ùüêùüéùüêùüî/ùüê/ùüê ‚Äì ùüê/ùüî
ùüî. ùüêùüéùüêùüî/ùüê/ùüó ‚Äì ùüê/ùüèùüë`,
              en: `Free delivery (West Malaysia)
[TOTAL: RM]

üìÆ Shipping Details

Name:
Phone:
Address:
Delivery week:`
            },
            lalamove: {
              zh: `„ÄêËøêË¥πÔºöRM„Äë
„ÄêTOTAL: RM„Äë

Êèê‰æõÂú∞ÂùÄÂêéÂ∏Æ‰Ω†Êü•ÁúãËøêË¥πüòâ

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÊó•Ôºö`,
              en: `[Delivery fee: RM]
[TOTAL: RM]

Share your address and we‚Äôll check the delivery fee for you üòâ

üìÆ Delivery Details

Name:
Phone:
Address:
Delivery date:`
            },
            pickup: {
              zh: `„ÄêTOTAL: RM„Äë

üì¶Ëá™ÂèñËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Ëá™ÂèñÂú∞ÁÇπÔºö
Ëá™ÂèñÊó•ÊúüÔºö
Ëá™ÂèñÊó∂Èó¥Ôºö`,
              en: `[TOTAL: RM]

üì¶ Self Pickup Details

Name:
Phone:
Pickup location:
Pickup date:
Pickup time:`
            }
          },
          east: {
            delivery: {
              zh: `„ÄêËøêË¥πÔºöRM„Äë
„ÄêTOTAL: RM„Äë

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÂë®Ôºö

ÂèØ‰ªé‰ª•‰∏ãÊó•ÊúüÈÄâÊã©ÂèëË¥ßÂë®
Êàë‰ª¨‰ºöÂú®ÈÇ£Âë®ÁöÑÊòüÊúü‰∏ÄËá≥ÊòüÊúü‰∫î‰ªª‰Ωï‰∏ÄÂ§©ÂèëË¥ß
ÂØÑÂá∫Âêé‰ºöÂú®1-3Â§©ÂÜÖÊî∂Âà∞üòâ

ùüè. ùüêùüéùüêùüî/ùüè/ùüì ‚Äì ùüè/ùüó
ùüê. ùüêùüéùüêùüé/ùüè/ùüèùüê ‚Äì ùüè/ùüèùüî
ùüë. ùüêùüéùüêùüî/ùüè/ùüèùüó ‚Äì ùüè/ùüêùüë
ùüí. ùüêùüéùüêùüî/ùüè/ùüêùüî ‚Äì ùüè/ùüèùüëùüé
ùüì. ùüêùüéùüêùüî/ùüê/ùüê ‚Äì ùüê/ùüî
ùüî. ùüêùüéùüêùüî/ùüê/ùüó ‚Äì ùüê/ùüèùüë`,
              en: `[Delivery fee: RM]
[TOTAL: RM]

üìÆ Shipping Details

Name:
Phone:
Address:
Delivery week:`
            }
          },
          singapore: {
            delivery: {
              zh: `ËøêË¥πÔºö$12
„ÄêTOTAL: $„Äë

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÊó•Ôºö`,
              en: `Delivery fee: $12
[TOTAL: $]

üìÆ Delivery Details

Name:
Phone:
Address:
Delivery date:`
            },
            lalamove: {
              zh: `„ÄêËøêË¥πÔºö$„Äë
„ÄêTOTAL: $„Äë

Êèê‰æõÂú∞ÂùÄÂêéÂ∏Æ‰Ω†Êü•ÁúãËøêË¥πüòâ

üìÆÈÇÆÂØÑËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Âú∞ÂùÄÔºö
ÂèëË¥ßÊó•Ôºö`,
              en: `[Delivery fee: $]
[TOTAL: $]

Share your address and we‚Äôll check the delivery fee for you üòâ

üìÆ Delivery Details

Name:
Phone:
Address:
Delivery date:`
            },
            pickup: {
              zh: `„ÄêTOTAL: $„Äë

üì¶Ëá™ÂèñËµÑÊñô

ÂêçÂ≠óÔºö
Âè∑Á†ÅÔºö
Ëá™ÂèñÂú∞ÁÇπÔºö
Ëá™ÂèñÊó•ÊúüÔºö
Ëá™ÂèñÊó∂Èó¥Ôºö`,
              en: `[TOTAL: $]

üì¶ Self Pickup Details

Name:
Phone:
Pickup location:
Pickup date:
Pickup time:`
            }
          }
        }
      },

      eastShippingRatesByBrand: {
        svelette: { '1': 22, '2': 30, '3': 38, '4+': 0 },
        chyu: { '1': 22, '2': 30, '3': 38, '4+': 0 }
      },

      audit: { updated_at: null, updated_by: null }
    });

    let state = defaultState();

    /**********************
     * 7) Supabase REST
     **********************/
    function canUseCloud() {
      return !!(SUPABASE_URL && SUPABASE_ANON_KEY);
    }

    async function supabaseUpsertKV(key, valueObj) {
      if (!canUseCloud()) return;
      const url = `${SUPABASE_URL}/rest/v1/kv_store?on_conflict=team,key`;
      const payload = [{
        team: TEAM_KEY,
        key,
        value: valueObj,
        updated_at: new Date().toISOString(),
        updated_by: getOperator() || "UNKNOWN"
      }];

      await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "Prefer": "resolution=merge-duplicates,return=representation"
        },
        body: JSON.stringify(payload)
      });
    }

    async function supabaseGetKV(key) {
      if (!canUseCloud()) return null;
      const url = `${SUPABASE_URL}/rest/v1/kv_store?team=eq.${encodeURIComponent(TEAM_KEY)}&key=eq.${encodeURIComponent(key)}&select=value,updated_at,updated_by`;
      const res = await fetch(url, {
        headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": `Bearer ${SUPABASE_ANON_KEY}` }
      });
      if (!res.ok) return null;
      const rows = await res.json();
      if (!rows || !rows[0]) return null;
      return rows[0];
    }

    /**********************
     * 8) Êú¨Êú∫‰øùÂ≠ò + ‰∫ëÁ´Ø‰øùÂ≠ò
     **********************/
    function saveLocal() { localStorage.setItem(LS_KEYS.APP_STATE, JSON.stringify(state)); }

    function getOperator() {
      const op = localStorage.getItem(LS_KEYS.OPERATOR);
      return (op && op.trim()) ? op.trim() : null;
    }

    async function saveAll() {
      state.audit.updated_at = new Date().toISOString();
      state.audit.updated_by = getOperator() || state.audit.updated_by || "UNKNOWN";
      saveLocal();
      await supabaseUpsertKV("app_state", state);
    }

    async function loadAll() {
      const local = localStorage.getItem(LS_KEYS.APP_STATE);
      if (local) { try { state = JSON.parse(local); } catch (e) {} }
      const cloud = await supabaseGetKV("app_state");
      if (cloud && cloud.value) { state = cloud.value; saveLocal(); }
    }

    /**********************
     * 9) Èò≤Ê≠¢Êóß state Êää MENU/EDIT ÂºÑÂ¥©
     *    ‚úÖ ÂÖºÂÆπÊóßÊ®°ÊùøÔºöÂ¶ÇÊûúÂèëÁé∞ÊòØ stringÔºåÂàôËá™Âä®ÂçáÁ∫ßÊàê {zh: string, en: "" }
     **********************/
    function normalizeTemplatesToBilingual(templatesByBrand) {
      if (!templatesByBrand) return;

      const brands = ["svelette","chyu"];
      const regions = ["west","east","singapore"];
      const methods = ["delivery","lalamove","pickup"];

      brands.forEach(b => {
        if (!templatesByBrand[b]) return;
        regions.forEach(r => {
          if (!templatesByBrand[b][r]) return;
          methods.forEach(m => {
            const v = templatesByBrand[b][r][m];
            if (typeof v === "string") {
              templatesByBrand[b][r][m] = { zh: v, en: "" };
            } else if (v && typeof v === "object") {
              if (typeof v.zh !== "string") v.zh = "";
              if (typeof v.en !== "string") v.en = "";
            } else if (v == null) {
              templatesByBrand[b][r][m] = { zh: "", en: "" };
            }
          });
        });
      });
    }

    function normalizeState() {
      if (!["new","menu","edit"].includes(state.currentPage)) state.currentPage = "new";
      if (!state.currentBrand || !brandData[state.currentBrand]) state.currentBrand = "svelette";
      if (!["west","east","singapore"].includes(state.currentRegion)) state.currentRegion = "west";
      if (!state.currentLang || !["zh","en"].includes(state.currentLang)) state.currentLang = "zh";

      if (!state.menuItemsStateByBrand || !state.savedTemplatesByBrand || !state.eastShippingRatesByBrand) {
        state = defaultState();
      }

      ["svelette","chyu"].forEach(b => {
        if (!state.menuItemsStateByBrand[b]) {
          state.menuItemsStateByBrand[b] = brandData[b].menu.map(item => ({
            ...item, visible: true, customName: item.name, customPrice: item.price
          }));
        }
        if (!state.savedTemplatesByBrand[b]) state.savedTemplatesByBrand[b] = defaultState().savedTemplatesByBrand[b];
        if (!state.eastShippingRatesByBrand[b]) state.eastShippingRatesByBrand[b] = defaultState().eastShippingRatesByBrand[b];
      });

      // ‚úÖ ÂçáÁ∫ßÊóßÊ®°ÊùøÂà∞ÂèåËØ≠
      normalizeTemplatesToBilingual(state.savedTemplatesByBrand);
    }

    /**********************
     * 10) ÂØºÂá∫/ÂØºÂÖ• JSON
     **********************/
    function downloadJSON(filename, obj) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 500);
    }

    async function importJSONFile(file) {
      const text = await file.text();
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== "object" || !obj.menuItemsStateByBrand) {
        alert("Â§á‰ªΩÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ");
        return;
      }
      state = obj;
      normalizeState();
      await saveAll();
      render();
      alert("Â∑≤ÂØºÂÖ•Âπ∂ÂêåÊ≠•");
    }

    /**********************
     * 11) Â§çÂà∂ÔºàÁ®≥ÂÆöÔºâ
     **********************/
    async function copyTextStable(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (e) {}
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      } catch (e) {
        return false;
      }
    }

    /**********************
     * 12) History (local)
     **********************/
    function loadHistory() {
      try { const raw = localStorage.getItem(LS_KEYS.HISTORY); return raw ? JSON.parse(raw) : []; }
      catch { return []; }
    }
    function saveHistory(list) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(list.slice(0, 30))); }
    function pushHistory(entry) { const list = loadHistory(); list.unshift(entry); saveHistory(list); }
    function openHistoryModal() { renderHistoryList(); document.getElementById("history-modal").style.display = "flex"; }
    function closeHistoryModal() { document.getElementById("history-modal").style.display = "none"; }
    function renderHistoryList() {
      const list = loadHistory();
      const el = document.getElementById("history-list");
      if (!list.length) { el.innerHTML = `<div class="modal-row sans-font" style="opacity:.7;">ÊöÇÊó†ËÆ∞ÂΩï</div>`; return; }
      el.innerHTML = list.map((x, idx) => `
        <div class="modal-row">
          <div class="flex items-center justify-between gap-3">
            <div class="sans-font" style="font-size:13px; letter-spacing:.5px;">
              <span class="allison" style="font-size:22px; color:#770008; margin-right:8px;">${escapeHtml(x.operator || "Unknown")}</span>
              <span style="opacity:.75;">¬∑</span>
              <span style="margin-left:8px; opacity:.9;">${escapeHtml(x.brandLabel)} / ${escapeHtml(x.regionLabel)} / ${escapeHtml(x.methodLabel)} / ${escapeHtml((x.langLabel||"").toUpperCase())}</span>
            </div>
            <div class="mono">${escapeHtml(x.time)}</div>
          </div>
          <div class="mt-2">
            <button class="gradient-btn sans-font px-4 py-2 rounded-full history-copy" data-idx="${idx}"
              style="font-size:12px; letter-spacing:1px; color:#3b1b1f;">COPY AGAIN</button>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".history-copy").forEach(btn => {
        btn.addEventListener("click", async () => {
          const idx = parseInt(btn.dataset.idx);
          const item = loadHistory()[idx];
          if (!item) return;
          const ok = await copyTextStable(item.text);
          btn.textContent = ok ? "‚úì COPIED" : "FAILED";
          setTimeout(() => (btn.textContent = "COPY AGAIN"), 1200);
        });
      });
    }

    document.getElementById("history-close").addEventListener("click", closeHistoryModal);
    document.getElementById("history-clear").addEventListener("click", () => { saveHistory([]); renderHistoryList(); });
    document.getElementById("history-modal").addEventListener("click", (e) => { if (e.target.id === "history-modal") closeHistoryModal(); });

    /**********************
     * 13) ‰∏öÂä°ÈÄªËæë
     **********************/
    function getConfig() { return { ...defaultConfig }; }

    function calculateEastShipping(itemCount, eastRates) {
      if (itemCount === 1) return eastRates['1'];
      if (itemCount === 2) return eastRates['2'];
      if (itemCount === 3) return eastRates['3'];
      return 0;
    }

    // ‚úÖ Êñ∞Â¢û langÔºö'zh' | 'en'
    function generateOrderSummary(groupedArray, total, method, shippingFee, lang = 'zh') {
      const region = state.currentRegion;
      const brand = state.currentBrand;
      const templates = state.savedTemplatesByBrand[brand];
      const currency = region === 'singapore' ? '$' : 'RM';

      let templateObj = null;
      if (region === 'west') templateObj = templates.west[method];
      else if (region === 'east') templateObj = templates.east[method];
      else templateObj = templates.singapore[method];

      // ÂÖºÂÆπÔºö‰∏á‰∏ÄÊòØ string
      let template = '';
      if (typeof templateObj === 'string') template = templateObj;
      else template = (templateObj && templateObj[lang]) ? templateObj[lang] : '';

      let itemsList = '';
      groupedArray.forEach(item => {
        const itemTotal = item.customPrice * item.quantity;
        itemsList += `${item.customName} x ${item.quantity} ${currency}${itemTotal}\n`;
      });

      let result = itemsList + '\n' + template;

      const isUnset = (shippingFee === null || shippingFee === undefined || Number.isNaN(shippingFee));

      // Ê≥®ÊÑèÔºö‰Ω†ÁöÑÊ®°ÊùøÈáåÁî®ÁöÑÊòØ „ÄêTOTAL: RM„Äë / „ÄêTOTAL: $„Äë ËøôÁßçÊ†áËÆ∞
      if (region === 'west' && method === 'lalamove') {
        if (isUnset) {
          result = result.replace(/„ÄêËøêË¥πÔºöRM„Äë/g, `ËøêË¥πÔºö`);
          result = result.replace(/„ÄêTOTAL: RM„Äë/g, `TOTAL: RM${total}`);
        } else {
          result = result.replace(/„ÄêËøêË¥πÔºöRM„Äë/g, `ËøêË¥πÔºöRM${shippingFee}`);
          result = result.replace(/„ÄêTOTAL: RM„Äë/g, `TOTAL: RM${total + shippingFee}`);
        }
        // Ëã±ÊñáÊ®°ÊùøÂèØËÉΩÁî® []Ôºå‰πüÊîØÊåÅÊõøÊç¢
        result = result.replace(/\[Delivery fee: RM\]/g, isUnset ? `Delivery fee:` : `Delivery fee: RM${shippingFee}`);
        result = result.replace(/\[TOTAL: RM\]/g, `TOTAL: RM${isUnset ? total : (total + shippingFee)}`);
        return result;
      }

      if (region === 'east' && method === 'delivery') {
        if (isUnset) {
          result = result.replace(/„ÄêËøêË¥πÔºöRM„Äë/g, `ËøêË¥πÔºö`);
          result = result.replace(/„ÄêTOTAL: RM„Äë/g, `TOTAL: RM${total}`);
        } else {
          result = result.replace(/„ÄêËøêË¥πÔºöRM„Äë/g, `ËøêË¥πÔºöRM${shippingFee}`);
          result = result.replace(/„ÄêTOTAL: RM„Äë/g, `TOTAL: RM${total + shippingFee}`);
        }
        result = result.replace(/\[Delivery fee: RM\]/g, isUnset ? `Delivery fee:` : `Delivery fee: RM${shippingFee}`);
        result = result.replace(/\[TOTAL: RM\]/g, `TOTAL: RM${isUnset ? total : (total + shippingFee)}`);
        return result;
      }

      if (region === 'singapore') {
        if (method === 'delivery') {
          result = result.replace(/„ÄêTOTAL: \$„Äë/g, `TOTAL: $${total + 12}`);
          result = result.replace(/\[TOTAL: \$\]/g, `TOTAL: $${total + 12}`);
          return result;
        }
        if (method === 'lalamove') {
          if (isUnset) {
            result = result.replace(/„ÄêËøêË¥πÔºö\$„Äë/g, `ËøêË¥πÔºö`);
            result = result.replace(/„ÄêTOTAL: \$„Äë/g, `TOTAL: $${total}`);
          } else {
            result = result.replace(/„ÄêËøêË¥πÔºö\$„Äë/g, `ËøêË¥πÔºö$${shippingFee}`);
            result = result.replace(/„ÄêTOTAL: \$„Äë/g, `TOTAL: $${total + shippingFee}`);
          }
          result = result.replace(/\[Delivery fee: \$\]/g, isUnset ? `Delivery fee:` : `Delivery fee: $${shippingFee}`);
          result = result.replace(/\[TOTAL: \$\]/g, `TOTAL: $${isUnset ? total : (total + shippingFee)}`);
          return result;
        }
        result = result.replace(/„ÄêTOTAL: \$„Äë/g, `TOTAL: $${total}`);
        result = result.replace(/\[TOTAL: \$\]/g, `TOTAL: $${total}`);
        return result;
      }

      result = result.replace(/„ÄêTOTAL: RM„Äë/g, `TOTAL: RM${total}`);
      result = result.replace(/„ÄêTOTAL: \$„Äë/g, `TOTAL: $${total}`);
      result = result.replace(/\[TOTAL: RM\]/g, `TOTAL: RM${total}`);
      result = result.replace(/\[TOTAL: \$\]/g, `TOTAL: $${total}`);
      return result;
    }

    /**********************
     * 14) ÁôªÂΩïÈ°µÔºàÈÄâÂêçÂ≠óÔºâ
     **********************/
    function isLoggedIn() {
      return localStorage.getItem(LS_KEYS.LOGGED_IN) === "1" && !!getOperator();
    }

    function setLoggedIn(operatorName) {
      localStorage.setItem(LS_KEYS.OPERATOR, operatorName);
      localStorage.setItem(LS_KEYS.LOGGED_IN, "1");
    }

    function logout() {
      localStorage.removeItem(LS_KEYS.LOGGED_IN);
      localStorage.removeItem(LS_KEYS.OPERATOR);
      render();
    }

    function renderLoginPage() {
      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;

      const app = document.getElementById('app');
      app.style.background = config.background_color;
      app.style.color = config.text_color;

      app.innerHTML = `
        <div class="w-full min-h-full flex items-center justify-center px-6" style="background:${config.background_color};">
          <div class="w-full max-w-4xl rounded-2xl p-10 md:p-12"
               style="background: rgba(255,255,255,0.66); border:1px solid ${config.secondary_action_color}30; box-shadow: 0 10px 30px rgba(0,0,0,0.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
            <div class="text-center mb-10">
              <div class="serif-font" style="font-size:${baseSize*3}px; letter-spacing:4px; font-weight:300; color:${config.primary_action_color};">
                CUSTOMER REPLY
              </div>
              <div class="sans-font mt-2" style="font-size:${baseSize*0.85}px; letter-spacing:2px; opacity:0.75;">
                TAP YOUR NAME TO START
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-5">
              ${OPERATOR_OPTIONS.map(name => `
                <button class="glass-btn sans-font rounded-full py-3 md:py-3.5 px-4 md:px-5 text-center"
                        data-name="${name}"
                        style="font-size:${baseSize*0.95}px; letter-spacing:1px; color:${config.text_color};">
                  <span class="allison" style="font-size:${baseSize*1.4}px; color:${config.primary_action_color}; display:block; margin-top:-2px;">${name}</span>
                </button>
              `).join("")}
            </div>
          </div>
        </div>
      `;

      document.querySelectorAll('button[data-name]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const name = btn.dataset.name;
          setLoggedIn(name);
          state.audit.updated_by = name;
          state.audit.updated_at = new Date().toISOString();
          saveLocal();
          render();
        });
      });
    }

    /**********************
     * 15) Ê∏≤ÊüìÔºà‰∏ªÊ°ÜÊû∂Ôºâ
     **********************/
    function render() {
      if (!isLoggedIn()) { renderLoginPage(); return; }

      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = 'sans-serif';

      const app = document.getElementById('app');
      app.style.background = config.background_color || defaultConfig.background_color;
      app.style.color = config.text_color || defaultConfig.text_color;
      app.style.fontFamily = `${config.font_family || defaultConfig.font_family}, ${baseFontStack}`;
      app.style.fontSize = `${baseSize}px`;

      const displayNameUpper = String(brandData[state.currentBrand].name || "").toUpperCase();

      const currentBrandLabel = state.currentBrand === 'svelette' ? 'SVELETTE' : 'CHYU';
      const operator = getOperator() || "Unknown";

      app.innerHTML = `
        <div class="w-full min-h-full" style="background: ${config.background_color};">
          <header class="text-center py-12 px-6" style="border-bottom: 1px solid ${config.secondary_action_color}; position: relative;">

            <!-- Floating Switcher (keep brand + menu icon) -->
            <div class="floating-switcher">
              <button id="brand-switcher" class="gradient-btn sans-font px-6 py-2 rounded-full"
                style="color: ${config.primary_action_color}; font-size: ${baseSize * 0.78}px; font-weight: 600; letter-spacing: 1.5px;">
                ${currentBrandLabel}
              </button>

              <button id="floating-menu-toggle" class="glass-btn icon-btn" aria-label="Open menu">
                <span class="hamburger" aria-hidden="true">
                  <span></span><span></span><span></span>
                </span>
              </button>

              <div id="floating-menu-panel" class="floating-panel" style="display:none;">
                <button id="floating-history" class="floating-item sans-font" style="color:${config.text_color}; font-size:${baseSize*0.85}px; letter-spacing:1px;">
                  History
                  <div class="floating-subtitle">Copy records</div>
                </button>
                <div class="divider"></div>

                <button id="floating-switch-user" class="floating-item sans-font" style="color:${config.text_color}; font-size:${baseSize*0.85}px; letter-spacing:1px;">
                  Switch User
                  <div class="floating-subtitle">Change operator</div>
                </button>
                <div class="divider"></div>

                <button id="floating-setting-toggle" class="floating-item sans-font" style="color:${config.text_color}; font-size:${baseSize*0.85}px; letter-spacing:1px;">
                  Backup
                  <div class="floating-subtitle">Export / Import JSON</div>
                </button>

                <div id="floating-setting-panel" style="display:none;">
                  <div class="divider"></div>
                  <div style="padding: 12px 14px;">
                    <button id="btn-export" class="glass-btn sans-font w-full px-4 py-2 rounded-full"
                      style="font-size:${baseSize * 0.75}px; letter-spacing:1px; cursor:pointer; color:${config.text_color};">
                      EXPORT JSON
                    </button>

                    <label class="glass-btn sans-font w-full mt-2 block px-4 py-2 rounded-full"
                      style="font-size:${baseSize * 0.75}px; letter-spacing:1px; cursor:pointer; color:${config.text_color}; text-align:center;">
                      IMPORT JSON
                      <input id="file-import" type="file" accept="application/json" style="display:none;" />
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- BRAND TITLE (UPPERCASE) -->
            <h1 class="serif-font mb-1"
              style="font-size: ${baseSize * 3}px; font-weight: 300; letter-spacing: 4px; color: ${config.primary_action_color};">
              ${escapeHtml(displayNameUpper)}
            </h1>

            <!-- Greeting -->
            <div class="text-center mt-4 mb-6">
              <div class="belleza" style="font-size:25px; color:#770008; line-height:1.1;">
                Happy New Year,
              </div>
            </div>

            <!-- Operator name BELOW divider -->
            <div class="operator-top">
              <div class="operator-name">${escapeHtml(operator)}</div>
            </div>

            <!-- REGION segmented -->
            <div class="w-full px-6 mb-5">
              <div class="seg-wrap">
                <div class="seg-group" role="tablist" aria-label="Region">
                  <button id="region-west" class="seg-btn sans-font" style="font-size:${baseSize*0.78}px;">
                    WEST MALAYSIA
                  </button>
                  <div class="seg-sep"></div>
                  <button id="region-east" class="seg-btn sans-font" style="font-size:${baseSize*0.78}px;">
                    EAST MALAYSIA
                  </button>
                  <div class="seg-sep"></div>
                  <button id="region-singapore" class="seg-btn sans-font" style="font-size:${baseSize*0.78}px;">
                    SINGAPORE
                  </button>
                </div>
              </div>
            </div>

            <!-- NAV segmented -->
            <nav class="w-full px-6">
              <div class="seg-wrap">
                <div class="seg-group" role="tablist" aria-label="Navigation">
                  <button id="nav-new" class="seg-btn sans-font" style="font-size:${baseSize*0.72}px;">NEW</button>
                  <div class="seg-sep"></div>
                  <button id="nav-menu" class="seg-btn sans-font" style="font-size:${baseSize*0.72}px;">MENU</button>
                  <div class="seg-sep"></div>
                  <button id="nav-edit" class="seg-btn sans-font" style="font-size:${baseSize*0.72}px;">EDIT</button>
                </div>
              </div>
            </nav>
          </header>

          <div id="page-content" class="flex flex-col lg:flex-row w-full"></div>
        </div>
      `;

      applyNavActiveStyles();
      applyRegionActiveStyles();
      attachHeaderListeners();

      if (state.currentPage === 'new') renderNewPage();
      else if (state.currentPage === 'menu') renderMenuEditPage();
      else { renderEditPage(); attachTemplateCopyListeners(); }
    }

    function applyRegionActiveStyles(){
      const west = document.getElementById("region-west");
      const east = document.getElementById("region-east");
      const sg = document.getElementById("region-singapore");
      [west,east,sg].forEach(b=>b && b.classList.remove("active"));
      if (state.currentRegion === "west") west && west.classList.add("active");
      if (state.currentRegion === "east") east && east.classList.add("active");
      if (state.currentRegion === "singapore") sg && sg.classList.add("active");
    }

    function applyNavActiveStyles() {
      const btnNew = document.getElementById("nav-new");
      const btnMenu = document.getElementById("nav-menu");
      const btnEdit = document.getElementById("nav-edit");
      [btnNew, btnMenu, btnEdit].forEach(b => b && b.classList.remove("active"));
      if (state.currentPage === "new") btnNew && btnNew.classList.add("active");
      if (state.currentPage === "menu") btnMenu && btnMenu.classList.add("active");
      if (state.currentPage === "edit") btnEdit && btnEdit.classList.add("active");
    }

    function attachHeaderListeners() {
      const btn = document.getElementById('brand-switcher');
      btn.addEventListener('click', async () => {
        state.currentBrand = state.currentBrand === 'svelette' ? 'chyu' : 'svelette';
        state.selectedItems = [];
        await saveAll();
        render();
      });

      const menuToggle = document.getElementById('floating-menu-toggle');
      const menuPanel = document.getElementById('floating-menu-panel');
      const settingToggle = document.getElementById('floating-setting-toggle');
      const settingPanel = document.getElementById('floating-setting-panel');

      function closeMenus() {
        if (menuPanel) menuPanel.style.display = 'none';
        if (settingPanel) settingPanel.style.display = 'none';
        if (menuToggle) menuToggle.classList.remove('is-open');
      }

      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menuPanel.style.display !== 'none';
        if (isOpen) closeMenus();
        else { menuPanel.style.display = 'block'; menuToggle.classList.add('is-open'); }
      });

      if (settingToggle) {
        settingToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          const open = settingPanel.style.display !== 'none';
          settingPanel.style.display = open ? 'none' : 'block';
        });
      }

      const historyBtn = document.getElementById("floating-history");
      if (historyBtn) historyBtn.addEventListener("click", () => { closeMenus(); openHistoryModal(); });

      const floatingSwitchUser = document.getElementById('floating-switch-user');
      if (floatingSwitchUser) floatingSwitchUser.addEventListener('click', () => { closeMenus(); logout(); });

      const exportBtn = document.getElementById('btn-export');
      if (exportBtn) exportBtn.addEventListener('click', () => downloadJSON(`backup_${TEAM_KEY}_${new Date().toISOString().slice(0,10)}.json`, state));

      const fileImport = document.getElementById('file-import');
      if (fileImport) {
        fileImport.addEventListener('change', async (e) => {
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          await importJSONFile(f);
          e.target.value = "";
          closeMenus();
        });
      }

      document.addEventListener('click', closeMenus);
      window.addEventListener('scroll', closeMenus, { passive: true });

      document.getElementById('region-west').addEventListener('click', async () => { state.currentRegion='west'; state.selectedItems=[]; await saveAll(); render(); });
      document.getElementById('region-east').addEventListener('click', async () => { state.currentRegion='east'; state.selectedItems=[]; await saveAll(); render(); });
      document.getElementById('region-singapore').addEventListener('click', async () => { state.currentRegion='singapore'; state.selectedItems=[]; await saveAll(); render(); });

      document.getElementById('nav-new').addEventListener('click', () => { state.currentPage='new'; render(); });
      document.getElementById('nav-menu').addEventListener('click', () => { state.currentPage='menu'; render(); });
      document.getElementById('nav-edit').addEventListener('click', () => { state.currentPage='edit'; render(); });
    }

    /**********************
     * NEW PAGE
     **********************/
    function renderNewPage() {
      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;
      const pageContent = document.getElementById('page-content');

      const currency = state.currentRegion === 'singapore' ? '$' : 'RM';
      const menuItemsState = state.menuItemsStateByBrand[state.currentBrand];

      pageContent.innerHTML = `
        <main class="flex-1 px-8 py-12">
          <section class="mb-16">
            <div class="flex items-center gap-4 mb-8">
              <span class="category-badge" style="background: ${config.primary_action_color}20; color: ${config.primary_action_color};">Êñ∞Âπ¥Á§ºÁõí</span>
              <div class="flex-1 h-px" style="background: ${config.secondary_action_color};"></div>
            </div>
            <div class="grid gap-6">
              ${menuItemsState.filter(i => i.visible).map(item => `
                <div class="menu-item p-6 rounded-lg glass-btn" data-item='${JSON.stringify(item)}'
                  style="background: rgba(255,255,255,0.75);">
                  <div class="flex justify-between items-center">
                    <h3 class="serif-font" style="font-size: ${baseSize * 1.5}px; font-weight: 400; color: ${config.text_color};">${escapeHtml(item.customName)}</h3>
                    <span class="serif-font" style="font-size: ${baseSize * 1.4}px; color: ${config.primary_action_color}; font-weight: 400;">${currency}${item.customPrice}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </section>
        </main>

        <aside class="w-full lg:w-96 px-8 py-12" style="background: ${config.surface_color}10; border-left: 1px solid ${config.secondary_action_color};">
          <h2 class="serif-font mb-8 text-center" style="font-size: ${baseSize * 1.8}px; color: ${config.primary_action_color}; font-weight: 400;">ÊÇ®ÁöÑÈÄâÊã©</h2>
          <div id="cart-list" class="space-y-4 mb-8"></div>

          <div class="pt-6" style="border-top: 2px solid ${config.primary_action_color};">
            <div class="flex justify-between items-center mb-6">
              <span class="serif-font" style="font-size: ${baseSize * 1.5}px; font-weight: 400; color: ${config.text_color};">Total</span>
              <span id="total-price" class="serif-font" style="font-size: ${baseSize * 2}px; color: ${config.primary_action_color}; font-weight: 400;">${currency}0</span>
            </div>
            <button id="place-order-btn" class="w-full py-4 rounded-lg sans-font gradient-btn"
              style="color: ${config.text_color}; font-size: ${baseSize * 1.05}px; font-weight: 600; letter-spacing: 2px; cursor: pointer;">
              NEXT
            </button>
          </div>
        </aside>
      `;

      attachMenuClickListeners();
      updateCart();
    }

    function attachMenuClickListeners() {
      const config = getConfig();
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', async function() {
          const itemData = JSON.parse(this.dataset.item);
          state.selectedItems.push(itemData);
          await saveAll();
          updateCart();

          document.querySelectorAll('.menu-item').forEach(el => {
            el.classList.remove('selected-item');
            el.style.borderLeftColor = '';
          });
          this.classList.add('selected-item');
          this.style.borderLeftColor = config.primary_action_color;

          setTimeout(() => {
            this.classList.remove('selected-item');
            this.style.borderLeftColor = '';
          }, 260);
        });
      });
    }

    function updateCart() {
      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;
      const cartList = document.getElementById('cart-list');
      const totalPrice = document.getElementById('total-price');
      const currency = state.currentRegion === 'singapore' ? '$' : 'RM';

      if (!cartList || !totalPrice) return;

      if (state.selectedItems.length === 0) {
        cartList.innerHTML = `<p class="sans-font text-center" style="opacity: 0.5; font-size: ${baseSize * 0.9}px; color: ${config.text_color};">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©</p>`;
        totalPrice.textContent = `${currency}0`;
        return;
      }

      const groupedItems = {};
      state.selectedItems.forEach(item => {
        if (groupedItems[item.id]) groupedItems[item.id].quantity++;
        else groupedItems[item.id] = { ...item, quantity: 1 };
      });

      let total = 0;
      const groupedArray = Object.values(groupedItems);

      cartList.innerHTML = groupedArray.map(item => {
        const itemTotal = item.customPrice * item.quantity;
        total += itemTotal;
        return `
          <div class="cart-item p-4 rounded-lg glass-btn" style="background: rgba(255,255,255,0.75);">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <h4 class="serif-font" style="font-size: ${baseSize * 1.1}px; font-weight: 400; color: ${config.text_color};">${escapeHtml(item.customName)}</h4>
                ${item.quantity > 1 ? `<span class="sans-font" style="font-size: ${baseSize * 0.85}px; opacity: 0.6; color: ${config.text_color};">x${item.quantity}</span>` : ''}
              </div>
              <button class="remove-btn sans-font" style="color: ${config.secondary_action_color}; font-size: ${baseSize * 1.5}px; opacity: 0.7; line-height: 1; cursor: pointer; background: none; border: none; padding: 0;" data-id="${item.id}">√ó</button>
            </div>
            <div class="serif-font text-right mt-2" style="font-size: ${baseSize * 1.1}px; color: ${config.primary_action_color}; font-weight: 400;">${currency}${itemTotal}</div>
          </div>
        `;
      }).join('');

      totalPrice.textContent = `${currency}${total}`;

      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.stopPropagation();
          const itemId = this.dataset.id;
          const index = state.selectedItems.findIndex(i => i.id === itemId);
          if (index !== -1) state.selectedItems.splice(index, 1);
          await saveAll();
          updateCart();
        });
      });

      const placeOrderBtn = document.getElementById('place-order-btn');
      if (placeOrderBtn) {
        placeOrderBtn.onclick = null;
        placeOrderBtn.addEventListener('click', () => showDeliveryOptions(groupedArray, total));
      }
    }

    function showDeliveryOptions(groupedArray, total) {
      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;
      const orderSection = document.querySelector('.pt-6');
      if (!orderSection) return;

      let deliveryOptions = '';
      if (state.currentRegion === 'west') {
        deliveryOptions = `
          <button class="delivery-option w-full py-4 px-6 rounded-lg sans-font gradient-btn" data-method="delivery"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:600; letter-spacing:1.5px; cursor:pointer;">
            DELIVERY
          </button>
          <button class="delivery-option w-full py-4 px-6 rounded-lg sans-font gradient-btn" data-method="lalamove"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:600; letter-spacing:1.5px; cursor:pointer;">
            LALAMOVE
          </button>
          <!-- ‚úÖ ËøôÈáåÊää SELF PICKUP È¢úËâ≤ÊîπÊàêË∑üÂÖ∂ÂÆÉ‰∏ÄÊ†∑Ôºàgradient-btnÔºâ -->
          <button class="delivery-option w-full py-4 px-6 rounded-lg sans-font gradient-btn" data-method="pickup"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:600; letter-spacing:1.5px; cursor:pointer;">
            SELF PICKUP
          </button>
        `;
      } else if (state.currentRegion === 'east') {
        deliveryOptions = `
          <button class="delivery-option w-full py-4 px-6 rounded-lg sans-font gradient-btn" data-method="delivery"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:600; letter-spacing:1.5px; cursor:pointer;">
            DELIVERY
          </button>
        `;
      } else {
        deliveryOptions = `
          <button class="delivery-option w-full py-4 px-6 rounded-lg sans-font gradient-btn" data-method="delivery"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:600; letter-spacing:1.5px; cursor:pointer;">
            DELIVERY
          </button>
          <button class="delivery-option w-full py-4 px-6 rounded-lg sans-font gradient-btn" data-method="lalamove"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:600; letter-spacing:1.5px; cursor:pointer;">
            LALAMOVE
          </button>
          <!-- ‚úÖ ËøôÈáå‰πüÊîπÊàê gradient-btn -->
          <button class="delivery-option w-full py-4 px-6 rounded-lg sans-font gradient-btn" data-method="pickup"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:600; letter-spacing:1.5px; cursor:pointer;">
            SELF PICKUP
          </button>
        `;
      }

      orderSection.innerHTML = `
        <div class="text-center mb-6">
          <h3 class="serif-font" style="font-size: ${baseSize * 1.5}px; color: ${config.primary_action_color}; font-weight: 400; margin-bottom: 10px;">ÈÄâÊã©ÈÖçÈÄÅÊñπÂºè</h3>
          <p class="sans-font" style="font-size: ${baseSize * 0.9}px; opacity: 0.7; color: ${config.text_color}; letter-spacing:1px;">Choose Delivery Method</p>
        </div>
        <div class="space-y-4">${deliveryOptions}</div>
      `;

      document.querySelectorAll('.delivery-option').forEach(btn => {
        btn.addEventListener('click', () => handleDeliveryMethodSelection(btn.dataset.method));
      });
    }

    function handleDeliveryMethodSelection(method) {
      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;
      const orderSection = document.querySelector('.pt-6');

      const groupedItems = {};
      state.selectedItems.forEach(item => {
        if (groupedItems[item.id]) groupedItems[item.id].quantity++;
        else groupedItems[item.id] = { ...item, quantity: 1 };
      });

      let total = 0;
      const groupedArray = Object.values(groupedItems);
      groupedArray.forEach(item => total += item.customPrice * item.quantity);

      const currency = state.currentRegion === 'singapore' ? '$' : 'RM';

      const itemsHTML = groupedArray.map(item => {
        const itemTotal = item.customPrice * item.quantity;
        return `<div class="flex justify-between" style="margin-bottom: 8px;">
          <span>${escapeHtml(item.customName)} x ${item.quantity}</span>
          <span style="color: ${config.primary_action_color};">„Äê${currency}${itemTotal}„Äë</span>
        </div>`;
      }).join('');

      const totalItemCount = groupedArray.reduce((sum, item) => sum + item.quantity, 0);

      if (state.currentRegion === 'west' && method === 'lalamove') {
        renderWestLalamoveOrder(orderSection, itemsHTML, total, currency, groupedArray, config, baseSize);
      } else if (state.currentRegion === 'east' && method === 'delivery') {
        renderEastDeliveryOrder(orderSection, itemsHTML, total, currency, groupedArray, totalItemCount, config, baseSize);
      } else if (state.currentRegion === 'singapore' && method === 'delivery') {
        renderSingaporeDeliveryOrder(orderSection, itemsHTML, total, currency, groupedArray, config, baseSize);
      } else if (state.currentRegion === 'singapore' && method === 'lalamove') {
        renderSingaporeLalamoveOrder(orderSection, itemsHTML, total, currency, groupedArray, config, baseSize);
      } else {
        renderStandardOrder(orderSection, itemsHTML, total, currency, groupedArray, method, config, baseSize);
      }
    }

    function renderWestLalamoveOrder(orderSection, itemsHTML, total, currency, groupedArray, config, baseSize) {
      orderSection.innerHTML = orderSummaryShell(config, baseSize, itemsHTML, `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid ${config.secondary_action_color}50;">
          <label for="shipping-fee-input" class="sans-font"
            style="display:block; font-size:${baseSize*0.9}px; margin-bottom:8px; color:${config.text_color};">
            ËøêË¥π (Optional)
          </label>
          <input type="number" id="shipping-fee-input" placeholder="ËæìÂÖ•ËøêË¥π" class="w-full p-2 rounded"
            style="border: 1px solid ${config.secondary_action_color}50; background:${config.background_color}; color:${config.text_color}; font-size:${baseSize*0.9}px;" />
          <div id="shipping-display" class="flex justify-between" style="margin-top: 8px; display:none;">
            <span>ËøêË¥π</span>
            <span id="shipping-amount" style="color:${config.primary_action_color};">„Äê${currency}„Äë</span>
          </div>
        </div>
        <div style="margin-top:16px; padding-top:16px; border-top:2px solid ${config.primary_action_color};">
          <div class="flex justify-between serif-font" style="font-size:${baseSize*1.3}px; font-weight:500;">
            <span>TOTAL:</span>
            <span id="total-display" style="color:${config.primary_action_color};">„Äê${currency}${total}„Äë</span>
          </div>
        </div>
      `);

      const shippingInput = document.getElementById('shipping-fee-input');
      const shippingDisplay = document.getElementById('shipping-display');
      const shippingAmount = document.getElementById('shipping-amount');
      const totalDisplay = document.getElementById('total-display');

      shippingInput.addEventListener('input', function() {
        const raw = this.value;
        const fee = raw === "" ? null : (parseFloat(raw) || null);
        if (fee === null) {
          shippingDisplay.style.display = 'none';
          totalDisplay.textContent = `„Äê${currency}${total}„Äë`;
          return;
        }
        shippingDisplay.style.display = 'flex';
        shippingAmount.textContent = `„Äê${currency}${fee}„Äë`;
        totalDisplay.textContent = `„Äê${currency}${total + fee}„Äë`;
      });

      attachOrderButtons(groupedArray, total, 'lalamove', config, baseSize);
    }

    function renderEastDeliveryOrder(orderSection, itemsHTML, total, currency, groupedArray, totalItemCount, config, baseSize) {
      const eastRates = state.eastShippingRatesByBrand[state.currentBrand];
      const autoShipping = calculateEastShipping(totalItemCount, eastRates);
      const needsManualInput = totalItemCount >= 4;

      orderSection.innerHTML = orderSummaryShell(config, baseSize, itemsHTML, `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid ${config.secondary_action_color}50;">
          ${needsManualInput ? `
            <label for="shipping-fee-input" class="sans-font"
              style="display:block; font-size:${baseSize*0.9}px; margin-bottom:8px; color:${config.text_color};">
              ËøêË¥π (4Â•óÊàñ‰ª•‰∏äÈúÄÊâãÂä®ËæìÂÖ•)
            </label>
            <input type="number" id="shipping-fee-input" placeholder="ËæìÂÖ•ËøêË¥π" class="w-full p-2 rounded"
              style="border: 1px solid ${config.secondary_action_color}50; background:${config.background_color}; color:${config.text_color}; font-size:${baseSize*0.9}px;" />
          ` : `
            <div class="flex justify-between" style="margin-top:8px;">
              <span>ËøêË¥π (${totalItemCount}Â•ó)</span>
              <span style="color:${config.primary_action_color};">„Äê${currency}${autoShipping}„Äë</span>
            </div>
          `}
        </div>
        <div style="margin-top:16px; padding-top:16px; border-top:2px solid ${config.primary_action_color};">
          <div class="flex justify-between serif-font" style="font-size:${baseSize*1.3}px; font-weight:500;">
            <span>TOTAL:</span>
            <span id="total-display" style="color:${config.primary_action_color};">„Äê${currency}${total + (needsManualInput ? 0 : autoShipping)}„Äë</span>
          </div>
        </div>
      `);

      if (needsManualInput) {
        const shippingInput = document.getElementById('shipping-fee-input');
        const totalDisplay = document.getElementById('total-display');
        shippingInput.addEventListener('input', function() {
          const raw = this.value;
          const fee = raw === "" ? null : (parseFloat(raw) || null);
          if (fee === null) totalDisplay.textContent = `„Äê${currency}${total}„Äë`;
          else totalDisplay.textContent = `„Äê${currency}${total + fee}„Äë`;
        });
      }

      attachOrderButtons(groupedArray, total, 'delivery', config, baseSize, { eastAutoShipping: (!needsManualInput ? autoShipping : null) });
    }

    function renderSingaporeDeliveryOrder(orderSection, itemsHTML, total, currency, groupedArray, config, baseSize) {
      const fixedShipping = 12;
      orderSection.innerHTML = orderSummaryShell(config, baseSize, itemsHTML, `
        <div style="margin-top:16px; padding-top:16px; border-top: 1px solid ${config.secondary_action_color}50;">
          <div class="flex justify-between">
            <span>ËøêË¥π</span>
            <span style="color:${config.primary_action_color};">„Äê${currency}${fixedShipping}„Äë</span>
          </div>
        </div>
        <div style="margin-top:16px; padding-top:16px; border-top:2px solid ${config.primary_action_color};">
          <div class="flex justify-between serif-font" style="font-size:${baseSize*1.3}px; font-weight:500;">
            <span>TOTAL:</span>
            <span style="color:${config.primary_action_color};">„Äê${currency}${total + fixedShipping}„Äë</span>
          </div>
        </div>
      `);
      attachOrderButtons(groupedArray, total, 'delivery', config, baseSize, { sgFixedShipping: fixedShipping });
    }

    function renderSingaporeLalamoveOrder(orderSection, itemsHTML, total, currency, groupedArray, config, baseSize) {
      orderSection.innerHTML = orderSummaryShell(config, baseSize, itemsHTML, `
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid ${config.secondary_action_color}50;">
          <label for="shipping-fee-input" class="sans-font"
            style="display:block; font-size:${baseSize*0.9}px; margin-bottom:8px; color:${config.text_color};">
            ËøêË¥π (Optional)
          </label>
          <input type="number" id="shipping-fee-input" placeholder="ËæìÂÖ•ËøêË¥π" class="w-full p-2 rounded"
            style="border: 1px solid ${config.secondary_action_color}50; background:${config.background_color}; color:${config.text_color}; font-size:${baseSize*0.9}px;" />
          <div id="shipping-display" class="flex justify-between" style="margin-top: 8px; display:none;">
            <span>ËøêË¥π</span>
            <span id="shipping-amount" style="color:${config.primary_action_color};">„Äê${currency}„Äë</span>
          </div>
        </div>
        <div style="margin-top:16px; padding-top:16px; border-top:2px solid ${config.primary_action_color};">
          <div class="flex justify-between serif-font" style="font-size:${baseSize*1.3}px; font-weight:500;">
            <span>TOTAL:</span>
            <span id="total-display" style="color:${config.primary_action_color};">„Äê${currency}${total}„Äë</span>
          </div>
        </div>
      `);

      const shippingInput = document.getElementById('shipping-fee-input');
      const shippingDisplay = document.getElementById('shipping-display');
      const shippingAmount = document.getElementById('shipping-amount');
      const totalDisplay = document.getElementById('total-display');

      shippingInput.addEventListener('input', function() {
        const raw = this.value;
        const fee = raw === "" ? null : (parseFloat(raw) || null);
        if (fee === null) {
          shippingDisplay.style.display = 'none';
          totalDisplay.textContent = `„Äê${currency}${total}„Äë`;
          return;
        }
        shippingDisplay.style.display = 'flex';
        shippingAmount.textContent = `„Äê${currency}${fee}„Äë`;
        totalDisplay.textContent = `„Äê${currency}${total + fee}„Äë`;
      });

      attachOrderButtons(groupedArray, total, 'lalamove', config, baseSize);
    }

    function renderStandardOrder(orderSection, itemsHTML, total, currency, groupedArray, method, config, baseSize) {
      const deliveryInfoHTML = (state.currentRegion === 'west' && method === 'delivery')
        ? `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid ${config.secondary_action_color}50;">
             <div class="sans-font" style="font-size: ${baseSize * 0.95}px; color: ${config.text_color}; opacity: 0.8;">Ë•øÈ©¨ÂåÖÈÇÆ</div>
           </div>`
        : '';

      orderSection.innerHTML = orderSummaryShell(config, baseSize, itemsHTML + deliveryInfoHTML, `
        <div style="margin-top:16px; padding-top:16px; border-top:2px solid ${config.primary_action_color};">
          <div class="flex justify-between serif-font" style="font-size:${baseSize*1.3}px; font-weight:500;">
            <span>TOTAL:</span>
            <span style="color:${config.primary_action_color};">„Äê${currency}${total}„Äë</span>
          </div>
        </div>
      `);

      attachOrderButtons(groupedArray, total, method, config, baseSize);
    }

    // ‚úÖ ÈáçÁÇπÔºöCOPY ÊåâÈíÆÊîπ‰∏∫‰∏§‰∏™ÔºöCOPYÔºà‰∏≠ÊñáÔºâ+ COPYÔºàEnglishÔºâ
    function orderSummaryShell(config, baseSize, itemsHTML, bottomHTML) {
      return `
        <div class="text-center mb-6">
          <h3 class="serif-font" style="font-size:${baseSize*1.8}px; color:${config.primary_action_color}; font-weight:400; margin-bottom:8px;">ËÆ¢ÂçïÊëòË¶Å</h3>
          <p class="sans-font" style="font-size:${baseSize*0.85}px; opacity:0.7; color:${config.text_color}; letter-spacing:1px;">Order Summary</p>
        </div>

        <div id="order-summary-box" class="p-4 rounded-lg mb-4 glass-btn" style="background: rgba(255,255,255,0.76);">
          <div class="sans-font" style="font-size:${baseSize*0.95}px; color:${config.text_color}; line-height:1.8;">
            ${itemsHTML}
            ${bottomHTML}
          </div>
        </div>

        <div class="space-y-3">
          <button id="copy-order-zh-btn" class="w-full py-4 rounded-lg sans-font gradient-btn"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:700; letter-spacing:1.5px; cursor:pointer;">
            COPYÔºà‰∏≠ÊñáÔºâ
          </button>

          <button id="copy-order-en-btn" class="w-full py-4 rounded-lg sans-font gradient-btn"
            style="color:${config.text_color}; font-size:${baseSize*1}px; font-weight:700; letter-spacing:1.5px; cursor:pointer;">
            COPYÔºàEnglishÔºâ
          </button>
        </div>

        <button id="reset-btn" class="w-full py-3 rounded-lg sans-font glass-btn mt-3"
          style="color:${config.secondary_action_color}; font-size:${baseSize*0.9}px; font-weight:700; letter-spacing:1.5px; cursor:pointer;">
          RESET
        </button>

        <p id="copy-feedback" class="text-center sans-font"
          style="font-size:${baseSize*0.85}px; margin-top:12px; opacity:0; transition: opacity 0.3s; color:${config.primary_action_color};">
          Â∑≤Â§çÂà∂ÔºÅCopied!
        </p>
      `;
    }

    function attachOrderButtons(groupedArray, total, method, config, baseSize, options = {}) {
      const copyZhBtn = document.getElementById('copy-order-zh-btn');
      const copyEnBtn = document.getElementById('copy-order-en-btn');
      const copyFeedback = document.getElementById('copy-feedback');
      const resetBtn = document.getElementById('reset-btn');

      async function doCopy(lang) {
        const region = state.currentRegion;
        let shippingFee = null;

        if (region === 'singapore' && method === 'delivery') {
          shippingFee = options.sgFixedShipping ?? 12;
        } else if (region === 'east' && method === 'delivery') {
          if (options.eastAutoShipping !== null && options.eastAutoShipping !== undefined) {
            shippingFee = options.eastAutoShipping;
          } else {
            const input = document.getElementById('shipping-fee-input');
            if (input) shippingFee = (input.value === "") ? null : (parseFloat(input.value) || null);
          }
        } else if (method === 'lalamove') {
          const input = document.getElementById('shipping-fee-input');
          if (input) shippingFee = (input.value === "") ? null : (parseFloat(input.value) || null);
        }

        const orderSummary = generateOrderSummary(groupedArray, total, method, shippingFee, lang);

        const ok = await copyTextStable(orderSummary);
        if (ok) {
          const operator = getOperator() || "Unknown";
          const brandLabel = state.currentBrand === "svelette" ? "SVELETTE" : "CHYU";
          const regionLabel = state.currentRegion === "west" ? "WEST MY" : (state.currentRegion === "east" ? "EAST MY" : "SG");
          const methodLabel = (method || "").toUpperCase();
          const langLabel = lang.toUpperCase();
          const t = new Date();
          const time = t.toLocaleString();

          pushHistory({ time, operator, brandLabel, regionLabel, methodLabel, langLabel, text: orderSummary });

          copyFeedback.style.opacity = '1';
          const btn = (lang === 'zh') ? copyZhBtn : copyEnBtn;
          if (btn) {
            const original = btn.textContent;
            btn.textContent = '‚úì COPIED';
            setTimeout(() => {
              copyFeedback.style.opacity = '0';
              btn.textContent = original;
            }, 1600);
          } else {
            setTimeout(() => (copyFeedback.style.opacity = '0'), 1600);
          }
        } else {
          alert("Â§çÂà∂Â§±Ë¥•ÔºöËØ∑ÈïøÊåâÊñáÂ≠óÂ§çÂà∂ / ÊàñÊ£ÄÊü•ÊµèËßàÂô®ÊùÉÈôê");
        }
      }

      if (copyZhBtn) copyZhBtn.addEventListener('click', () => doCopy('zh'));
      if (copyEnBtn) copyEnBtn.addEventListener('click', () => doCopy('en'));

      resetBtn.addEventListener('click', async () => { state.selectedItems = []; await saveAll(); render(); });
    }

    /**********************
     * MENU EDIT PAGE
     **********************/
    function renderMenuEditPage() {
      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;
      const pageContent = document.getElementById('page-content');
      const currency = state.currentRegion === 'singapore' ? '$' : 'RM';

      const menuItemsState = state.menuItemsStateByBrand[state.currentBrand];

      pageContent.innerHTML = `
        <div class="flex-1 px-8 py-12 max-w-5xl mx-auto w-full">
          <div class="flex justify-between items-center mb-8">
            <h2 class="serif-font" style="font-size: ${baseSize * 2}px; color: ${config.primary_action_color}; font-weight: 400; margin: 0;">Êñ∞Âπ¥Á§ºÁõí</h2>
            <button id="save-menu-btn" class="gradient-btn sans-font px-6 py-3 rounded-lg"
              style="color: ${config.text_color}; font-size: ${baseSize * 0.9}px; font-weight: 700; letter-spacing: 1.5px; cursor: pointer;">
              SAVE CHANGES
            </button>
          </div>

          <div class="mb-6 p-4 rounded-lg glass-btn" style="background: rgba(255,255,255,0.70); border-left: 3px solid ${config.primary_action_color};">
            <p class="sans-font" style="font-size: ${baseSize * 0.85}px; color: ${config.text_color}; line-height: 1.6; margin: 0;">
              üí° <strong>ÊèêÁ§∫Ôºö</strong>ÂèØ‰ª•ÁºñËæëÁ§ºÁõíÂêçÂ≠óÂíå‰ª∑Ê†º„ÄÇÈöêËóèÁöÑÁ§ºÁõí‰∏ç‰ºöÂú® NEW È°µÈù¢ÊòæÁ§∫„ÄÇ
            </p>
          </div>

          <div class="space-y-4">
            ${menuItemsState.map((item, index) => `
              <div class="p-6 rounded-lg glass-btn" style="background: rgba(255,255,255,0.76);">
                <div class="flex items-start gap-4">
                  <div class="flex-1 space-y-4">
                    <div>
                      <label class="sans-font block mb-2" style="font-size: ${baseSize * 0.85}px; color: ${config.text_color}; opacity: 0.8;">Á§ºÁõíÂêçÂ≠ó</label>
                      <input type="text" class="menu-name-input w-full p-3 rounded sans-font"
                        data-index="${index}" value="${escapeHtml(item.customName)}"
                        style="border: 1px solid ${config.secondary_action_color}40; background: rgba(250,248,245,0.8); color: ${config.text_color}; font-size: ${baseSize * 0.95}px;" />
                    </div>
                    <div>
                      <label class="sans-font block mb-2" style="font-size: ${baseSize * 0.85}px; color: ${config.text_color}; opacity: 0.8;">‰ª∑Ê†º (${currency})</label>
                      <input type="number" class="menu-price-input w-full p-3 rounded sans-font"
                        data-index="${index}" value="${item.customPrice}"
                        style="border: 1px solid ${config.secondary_action_color}40; background: rgba(250,248,245,0.8); color: ${config.text_color}; font-size: ${baseSize * 0.95}px;" />
                    </div>
                  </div>

                  <div class="flex flex-col gap-3">
                    <button class="toggle-visibility-btn sans-font px-4 py-2 rounded-full transition-all glass-btn"
                      data-index="${index}"
                      style="color:${config.text_color}; font-size:${baseSize * 0.82}px; cursor:pointer; white-space: nowrap; min-width: 110px;">
                      ${item.visible ? 'VISIBLE' : 'HIDDEN'}
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      document.querySelectorAll('.menu-name-input').forEach(input => {
        input.addEventListener('input', function() {
          const index = parseInt(this.dataset.index);
          menuItemsState[index].customName = this.value;
        });
      });

      document.querySelectorAll('.menu-price-input').forEach(input => {
        input.addEventListener('input', function() {
          const index = parseInt(this.dataset.index);
          menuItemsState[index].customPrice = parseFloat(this.value) || 0;
        });
      });

      document.querySelectorAll('.toggle-visibility-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          menuItemsState[index].visible = !menuItemsState[index].visible;
          this.textContent = menuItemsState[index].visible ? 'VISIBLE' : 'HIDDEN';
          this.style.borderColor = menuItemsState[index].visible ? 'rgba(139,0,0,0.35)' : 'rgba(160,97,106,0.28)';
          this.style.color = menuItemsState[index].visible ? config.primary_action_color : config.text_color;
        });
      });

      const saveBtn = document.getElementById('save-menu-btn');
      saveBtn.addEventListener('click', async function() {
        await saveAll();
        this.textContent = '‚úì SAVED';
        setTimeout(() => (this.textContent = 'SAVE CHANGES'), 1200);
      });
    }

    /**********************
     * EDIT PAGE
     * ‚úÖ ÊØè‰∏™Ê®°ÊùøÂàÜÊàê ‰∏≠Êñá / English ‰∏§‰∏™ textarea
     **********************/
    function renderEditPage() {
      const config = getConfig();
      const baseSize = config.font_size || defaultConfig.font_size;
      const pageContent = document.getElementById('page-content');

      const templates = state.savedTemplatesByBrand[state.currentBrand];
      const eastRates = state.eastShippingRatesByBrand[state.currentBrand];

      let editContent = '';
      if (state.currentRegion === 'west') {
        editContent = `
          <div class="space-y-8">
            ${templateBlock('west', 'delivery', 'üìÆ DELIVERY Ê®°Êùø', templates.west.delivery, config, baseSize)}
            ${templateBlock('west', 'lalamove', 'üöö LALAMOVE Ê®°Êùø', templates.west.lalamove, config, baseSize)}
            ${templateBlock('west', 'pickup', 'üì¶ SELF PICKUP Ê®°Êùø', templates.west.pickup, config, baseSize)}
          </div>
        `;
      } else if (state.currentRegion === 'east') {
        editContent = `
          <div class="space-y-8">
            <div class="p-6 rounded-lg glass-btn" style="background: rgba(255,255,255,0.76);">
              <h3 class="serif-font mb-4" style="font-size: ${baseSize * 1.5}px; color: ${config.primary_action_color}; font-weight: 400;">üì¶ EDIT SHIPPING RATES</h3>

              ${rateRow("rate-1","1Â•óËøêË¥πÔºö", eastRates['1'], config, baseSize)}
              ${rateRow("rate-2","2Â•óËøêË¥πÔºö", eastRates['2'], config, baseSize)}
              ${rateRow("rate-3","3Â•óËøêË¥πÔºö", eastRates['3'], config, baseSize)}

              <div class="p-3 rounded glass-btn" style="background: rgba(250,248,245,0.75); border-left:3px solid ${config.secondary_action_color}; box-shadow:none;">
                <p class="sans-font" style="font-size:${baseSize*0.85}px; color:${config.text_color};">üí° 4Â•óÊàñ‰ª•‰∏äÈúÄË¶ÅÊâãÂä®Â°´ÂÜôËøêË¥π</p>
              </div>
            </div>

            ${templateBlock('east', 'delivery', 'üìÆ DELIVERY Ê®°Êùø', templates.east.delivery, config, baseSize)}
          </div>
        `;
      } else {
        editContent = `
          <div class="space-y-8">
            ${templateBlock('singapore', 'delivery', 'üìÆ DELIVERY Ê®°Êùø', templates.singapore.delivery, config, baseSize)}
            ${templateBlock('singapore', 'lalamove', 'üöö LALAMOVE Ê®°Êùø', templates.singapore.lalamove, config, baseSize)}
            ${templateBlock('singapore', 'pickup', 'üì¶ SELF PICKUP Ê®°Êùø', templates.singapore.pickup, config, baseSize)}
          </div>
        `;
      }

      pageContent.innerHTML = `
        <div class="flex-1 px-8 py-12 max-w-4xl mx-auto w-full">
          <div class="flex justify-between items-center mb-8">
            <h2 class="serif-font" style="font-size:${baseSize*2}px; color:${config.primary_action_color}; font-weight:400; margin:0;">ÁºñËæëÊ®°Êùø</h2>
            <button id="save-templates-btn" class="gradient-btn sans-font px-6 py-3 rounded-lg"
              style="color:${config.text_color}; font-size:${baseSize*0.9}px; font-weight:700; letter-spacing:1.5px; cursor:pointer;">
              SAVE
            </button>
          </div>

          <div class="mb-6 p-4 rounded-lg glass-btn" style="background: rgba(255,255,255,0.72); border-left:3px solid ${config.primary_action_color};">
            <p class="sans-font" style="font-size:${baseSize*0.85}px; color:${config.text_color}; line-height:1.6; margin:0;">
              ‚ö†Ô∏è <strong>ÈáçË¶ÅÊèêÁ§∫Ôºö</strong>Â∏¶„Äê„ÄëÁöÑÂÜÖÂÆπÔºàÂ¶Ç„ÄêRM100„Äë„ÄÅ„ÄêTOTAL: RM200„Äë„ÄÅ„ÄêËøêË¥πÔºöRM15„ÄëÔºâÊòØËá™Âä®ËÆ°ÁÆóÁöÑ‰ª∑Ê†ºÊ†áËÆ∞ÔºåËØ∑ÂãøÂà†Èô§Êàñ‰øÆÊîπËøô‰∫õÊ†áËÆ∞ÔºåÂê¶Âàô‰ª∑Ê†ºËÆ°ÁÆóÂäüËÉΩ‰ºöÂ§±Êïà„ÄÇÂÖ∂‰ªñÂÜÖÂÆπÂèØ‰ª•ÈöèÊÑèÁºñËæë„ÄÇ<br/>
              ‚úÖ Áé∞Âú®ÊØè‰∏™Ê®°ÊùøÈÉΩÊúâ„Äå‰∏≠Êñá / English„Äç‰∏§‰ªΩÔºåÂ§çÂà∂Êó∂‰ºöÊåâÊåâÈíÆËØ≠Ë®ÄÂØπÂ∫î„ÄÇ
            </p>
          </div>

          ${editContent}
        </div>
      `;

      document.getElementById('save-templates-btn').addEventListener('click', async function() {
        const brand = state.currentBrand;
        const region = state.currentRegion;

        function readBi(regionKey, methodKey) {
          const zhEl = document.getElementById(`${regionKey}-${methodKey}-template-zh`);
          const enEl = document.getElementById(`${regionKey}-${methodKey}-template-en`);
          return {
            zh: zhEl ? zhEl.value : "",
            en: enEl ? enEl.value : ""
          };
        }

        if (region === 'west') {
          state.savedTemplatesByBrand[brand].west.delivery = readBi('west','delivery');
          state.savedTemplatesByBrand[brand].west.lalamove = readBi('west','lalamove');
          state.savedTemplatesByBrand[brand].west.pickup = readBi('west','pickup');
        } else if (region === 'east') {
          state.eastShippingRatesByBrand[brand]['1'] = parseFloat(document.getElementById('rate-1').value) || 22;
          state.eastShippingRatesByBrand[brand]['2'] = parseFloat(document.getElementById('rate-2').value) || 30;
          state.eastShippingRatesByBrand[brand]['3'] = parseFloat(document.getElementById('rate-3').value) || 38;
          state.savedTemplatesByBrand[brand].east.delivery = readBi('east','delivery');
        } else {
          state.savedTemplatesByBrand[brand].singapore.delivery = readBi('singapore','delivery');
          state.savedTemplatesByBrand[brand].singapore.lalamove = readBi('singapore','lalamove');
          state.savedTemplatesByBrand[brand].singapore.pickup = readBi('singapore','pickup');
        }

        await saveAll();
        this.textContent = '‚úì SAVED';
        setTimeout(() => (this.textContent = 'SAVE'), 1200);
      });
    }

    // ‚úÖ ÂèåËØ≠Ê®°ÊùøÂùóÔºö‰∏§Â•ó textarea + ‰∏§‰∏™ copy
    function templateBlock(region, key, title, valueObj, config, baseSize) {
      const v = (typeof valueObj === 'string')
        ? { zh: valueObj, en: "" }
        : (valueObj || { zh: "", en: "" });

      return `
        <div class="p-6 rounded-lg glass-btn" style="background: rgba(255,255,255,0.76);">
          <div class="flex justify-between items-center mb-4">
            <h3 class="serif-font" style="font-size:${baseSize*1.5}px; color:${config.text_color}; font-weight:400;">${title}</h3>
            <div class="flex items-center gap-2">
              <button class="copy-template-btn sans-font px-4 py-2 rounded-full transition-all glass-btn"
                data-region="${region}" data-template="${key}" data-lang="zh"
                style="color:${config.primary_action_color}; font-size:${baseSize*0.82}px; cursor:pointer;">
                COPYÔºà‰∏≠ÊñáÔºâ
              </button>
              <button class="copy-template-btn sans-font px-4 py-2 rounded-full transition-all glass-btn"
                data-region="${region}" data-template="${key}" data-lang="en"
                style="color:${config.primary_action_color}; font-size:${baseSize*0.82}px; cursor:pointer;">
                COPYÔºàENÔºâ
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div class="sans-font mb-2" style="font-size:${baseSize*0.82}px; letter-spacing:1px; opacity:.75; color:${config.text_color};">‰∏≠ÊñáÊ®°Êùø</div>
              <textarea id="${region}-${key}-template-zh" class="w-full p-4 rounded sans-font" rows="${key==='delivery' ? 15 : 8}"
                style="border:1px solid ${config.secondary_action_color}30; background: rgba(250,248,245,0.78); color:${config.text_color};
                  font-size:${baseSize*0.9}px; line-height:1.8; resize:vertical;">${escapeHtml(v.zh || "")}</textarea>
            </div>

            <div>
              <div class="sans-font mb-2" style="font-size:${baseSize*0.82}px; letter-spacing:1px; opacity:.75; color:${config.text_color};">English Template</div>
              <textarea id="${region}-${key}-template-en" class="w-full p-4 rounded sans-font" rows="${key==='delivery' ? 15 : 8}"
                style="border:1px solid ${config.secondary_action_color}30; background: rgba(250,248,245,0.78); color:${config.text_color};
                  font-size:${baseSize*0.9}px; line-height:1.8; resize:vertical;">${escapeHtml(v.en || "")}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function rateRow(id, label, value, config, baseSize) {
      return `
        <div class="flex items-center gap-4 mb-4">
          <label class="sans-font" style="font-size:${baseSize*0.95}px; color:${config.text_color}; min-width:100px;">${label}</label>
          <input type="number" id="${id}" value="${value}" class="flex-1 p-2 rounded"
            style="border:1px solid ${config.secondary_action_color}40; background: rgba(250,248,245,0.78); color:${config.text_color}; font-size:${baseSize*0.9}px;" />
          <span class="sans-font" style="font-size:${baseSize*0.9}px; color:${config.text_color};">RM</span>
        </div>
      `;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function attachTemplateCopyListeners() {
      document.querySelectorAll('.copy-template-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const region = this.dataset.region;
          const tpl = this.dataset.template;
          const lang = this.dataset.lang || 'zh';
          const textarea = document.getElementById(`${region}-${tpl}-template-${lang}`);
          if (!textarea) return;
          const ok = await copyTextStable(textarea.value);
          if (ok) {
            const original = this.textContent;
            this.textContent = '‚úì COPIED';
            setTimeout(() => this.textContent = original, 1200);
          }
        });
      });
    }

    /**********************
     * ÂàùÂßãÂåñ
     **********************/
    (async function init() {
      await loadAll();
      normalizeState();
      render();
    })();
  </script>
</body>
</html>
